---
name: update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 16 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    container: ghcr.io/kunzese/pkgbuilds:latest
    strategy:
      matrix:
        package-group:
          - name: cloudsdk
            packages: "google-cloud-cli-firestore-emulator"
            version_cmd: "curl -s https://dl.google.com/dl/cloudsdk/channels/rapid/components-2.json | jq -r '.version'"
          - name: tfswitch
            packages: "tfswitch tfswitch-bin"
            version_cmd: "curl -s https://api.github.com/repos/warrensbox/terraform-switcher/releases/latest | jq -r '.tag_name' | sed 's/^v//'"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Adding working directory to the git global config as a safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Set up Git
        run: |
          git config --global user.name "${{ secrets.GIT_USER_NAME }}"
          git config --global user.email "${{ secrets.GIT_USER_EMAIL }}"

      - name: Update packages
        run: ./.github/scripts/update-package.sh "${{ matrix.package-group.version_cmd }}" ${{ matrix.package-group.packages }}

      - name: Create Pull Request and enable auto-merge
        run: |
          BRANCH_NAME="update-pkgbuild/${{ matrix.package-group.name }}"
          PR_TITLE="chore(${{ matrix.package-group.name }}): bump version to ${{ env.LATEST_VERSION }}"

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit"
            exit 0
          fi

          git switch -C "$BRANCH_NAME"
          git add -A
          git commit -m "$PR_TITLE"
          git push -f origin "$BRANCH_NAME"

          if PR_URL=$(gh pr view "$BRANCH_NAME" --json url --jq -r .url 2>/dev/null); then
            gh pr edit "$BRANCH_NAME" --title "$PR_TITLE"
            echo "Updated existing PR: $PR_URL"
          else
            PR_URL=$(gh pr create --base master --head "$BRANCH_NAME" --title "$PR_TITLE" --body "Automated version bump to ${{ env.LATEST_VERSION }}")
            echo "Created new PR: $PR_URL"
          fi

          if gh pr merge --auto --rebase "$BRANCH_NAME"; then
            echo "Auto-merge enabled for: $PR_URL"
          else
            echo "Failed to enable auto-merge for: $PR_URL"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_PKGBUILDS }}
